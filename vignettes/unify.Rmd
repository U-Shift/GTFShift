---
title: "GTFS unification"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GTFS unification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(GTFShift)

library(GTFSwizard)
library(mapview)
```


# Introduction 

Public transit analysis takes advantage of the standardized GTFS format. However, its provision by operator makes it difficult for network aggregated analysis, considering connectivity and multimodality. `GTFShift::unify` proposes a simple solution to this problem, generating an aggregated GTFS file given several instances of these.

> This article uses GTFS feeds from the library GTFS database for Portugal as an example. Refer to the \code{vignette("download")} for more details.

```{r}
# Get GTFS from library GTFS database for Portugal
data <- read.csv(system.file("extdata", "gtfs_sources_pt.csv", package = "GTFShift"))
gtfs_local <- lapply(data[c(4,8),]$ID, function(ID) {
  return(GTFShift::download(data$URL[data$ID == ID], sprintf("database/transit/%s_gtfs.zip", ID)))
})

# Load GTFS
gtfs_list <- lapply(gtfs_local, function(location) {
  return(GTFSwizard::read_gtfs(location))
})
```


# Unify GTFS

The unification is performed through `GTFShift::unify()`, producing a single GTFS instance, saved as a ZIP file. Option `generateTransfers` enables the generation of `transfers.txt`, aggregating close stops, even if from different GTFS. 

```{r}
# Perform unification
gtfs_united_path <- GTFShift::unify(gtfs_list, "database/transit/gtfs_unified.zip", generateTransfers=TRUE)
```
It can be displayed using `mapview`.

```{r}
gtfs_united <- GTFSwizard::read_gtfs(gtfs_united_path)
```

<div style="display: flex; gap: 20px; overflow-x: auto;">
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes
```{r}
mapview::mapview(GTFSwizard::get_shapes_sf(gtfs_united$shapes))
```
</div>
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated stops
```{r}
mapview::mapview(GTFSwizard::get_stops_sf(gtfs_united$stops))
```
</div>
</div>


