---
title: "Download GTFS files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Download GTFS files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(GTFShift)

library(tidytransit)
```


# Download GTFS files 

## Data source

The gathering of the GTFS files can be simplified by using public archives like [transitfeeds.com](https://transitfeeds.com/) or [transit.land](https://www.transit.land/).

This library offers a small database with a compilation of GTFS files for Portuguese operators. It is a CSV file, available at `extdata/gtfs_sources_pt.csv`, and has the following attributes:

- `ID`, a string unique identifier of the region/city the GTFS file applies to;
- `LastUpdate`, the date at which this database entry was last updated;
- `ReferenceDate`, a representative Wednesday that falls within the GTFS calendar;
- `URL`, the URL at which the GTFS file is available;
- `GTFSDocs`, the URL to the page that documents the operator GTFS.


```{r message=TRUE, warning=FALSE}
data <- read.csv(system.file("extdata", "gtfs_sources_pt.csv", package = "GTFShift"))
summary(data)
data[1:4,]
```

## Download and validate integrity

`GTFShift` library offers a method to download and fix any integrity violations at GTFS files: `GTFShift::download()`. It fixes inconsistencies on the `stop_times.txt` and missing `shapes.txt` files.

```{r}
# DOWNLOAD GTFS and store it locally
gtfs_local <- GTFShift::download(data[4,]$URL, sprintf("database/transit/%s_gtfs.zip", data[4,]$ID))
print(sprintf("GTFS downloaded and stored at %s", gtfs_local))
```

```{r}
gtfs <- tidytransit::read_gtfs(gtfs_local)
summary(gtfs)
```

