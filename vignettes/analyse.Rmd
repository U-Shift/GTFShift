---
title: "Analyse GTFS feeds"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse GTFS feeds}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
.leaflet-container {
  width: 100% !important;
  min-width: 0 !important;
  box-sizing: border-box;
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(GTFShift)

library(tidytransit)
library(mapview)
library(sf)
library(dplyr)
```


# Introduction 

Analyzing public transit feeds is important to understand its territorial coverage and dynamics, both on its spatial and temporal dimensions. `GTFShift` provides several methods that encapsulate pre-defined methodologies for them. This document explores their applicability with simple examples.

> This article uses a GTFS feed from the library GTFS database for Portugal as an example. Refer to the
[vignette("download")](./download) for more details.

```{r}
# Get GTFS from library GTFS database for Portugal
data <- read.csv(system.file("extdata", "gtfs_sources_pt.csv", package = "GTFShift"))
gtfs_id = "lisboa"
<<<<<<< Updated upstream
gtfs <- GTFShift::load_feed(data[data$ID==gtfs_id,]$URL)
gtfs <- GTFShift::load_feed("database/transit/lisboa_gtfs.zip")
=======
gtfs <- GTFShift::download_feed(data[data$ID==gtfs_id,]$URL)
gtfs <- GTFShift::download_feed("database/transit/lisboa_gtfs.zip")
>>>>>>> Stashed changes
```


# Analyse hourly frequency per stop

To analyse frequencies at stops, use `GTFShift::get_stop_hour_frequency()`, producing, for each, an aggregated counting of bus servicing it per hour.

```{r}
# Perform frequency analysis
frequencies_stop <- GTFShift::get_stop_frequency_hourly(gtfs)
summary(frequencies_stop)
```

Its returns an `sf` `data.frame` that can be displayed using mapview, or stored in GeoPackage format.

```{r}
# Display map
mapview::mapview(frequencies_stop, zcol="frequency", legend=TRUE, cex=4, layer.name = "Frequency (hour)")

# Store in GeoPackage format
st_write(frequencies_stop, "database/transit/bus_stop_frequency.gpkg", append=FALSE)
```



# Analyse hourly frequency per route

The frequency analysis can also be performed route wise. For this purpose, use `GTFShift::get_route_hour_frequency()`, returning aggregated results per hour.

The analysis can be performed for each route individually.
```{r}
frequencies_route <- GTFShift::get_route_frequency_hourly(gtfs)
summary(frequencies_route)
mapview(frequencies_route)
View(frequencies_route)
st_write(frequencies_route, "frequencies_route.gpkg")
```

```{python}
from shapely.geometry import Polygon
from centerline.geometry import Centerline
import geopandas as gpd

gdf = gpd.read_file("unioned_sf.gpkg")
polygon = gdf.geometry.iloc[0]
attributes = {
    "id": gdf.iloc[0].get("id", 1),  # fallback to 1 if 'id' column doesn't exist
    "name": gdf.iloc[0].get("name", "polygon"),  # fallback to 'polygon'
    "valid": True  # or fetch from file if applicable
}
centerline = Centerline(polygon, **attributes)


# Create a GeoDataFrame for centerline geometries
centerline_gdf = gpd.GeoDataFrame(
    {"id": [attributes["id"] for _ in centerline.geoms],
     "name": [attributes["name"] for _ in centerline.geoms]},
    geometry=[geom for geom in centerline.geoms],
    crs=gdf.crs
)

# Export to GeoPackage
centerline_gdf.to_file("centerline.gpkg", layer="centerline", driver="GPKG")
str(centerline_gdf)

centerline.name

```

```{python}
import neatnet
```

```{r}
library(reticulate)
reticulate::py_config()

reticulate::virtualenv_create("r-reticulate")
reticulate::use_virtualenv("r-reticulate")
reticulate::py_install("neatnet")
reticulate::py_module_available("neatnet")
neatnet <- reticulate::import("neatnet")
```




The `overline` parameter allows for an even more aggregated screening of the operation, clustering routes that overlap and converting them into a single route network. This allows for a better visualization of the volumes of frequencies per each segment of the network.

```{r}
frequencies_route_overline <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+07)
st_write(frequencies_route_overline %>% filter(arrival_hour==8), "overline_carris.gpkg")

frequencies_route_overline_5 <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+05)
frequencies_route_overline_4 <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+04)
frequencies_route_overline_3 <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+03)

frequencies_route_overline_8 <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+08)
frequencies_route_overline_9 <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+09)
frequencies_route_overline_12 <- GTFShift::get_route_frequency_hourly(gtfs, overline=1e+12)
# frequencies_route_overline_osm <- GTFShift::get_route_frequency_hourly(gtfs, overline_osm=TRUE)
summary(frequencies_route_overline)
summary(frequencies_route_overline_5)
summary(frequencies_route_overline_3)
```

<div style="display: flex; gap: 20px; overflow-x: auto;">
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes for 8 a.m.
```{r}
<<<<<<< Updated upstream
mapview::mapview(frequencies_route |> filter(arrival_hour==8 & frequency > 2), zcol = "frequency", layer.name = "Frequency (hour)")
=======
mapview::mapview(
  frequencies_route %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
>>>>>>> Stashed changes
st_write(frequencies_route, "frequencies_route.gpkg")

```
</div>
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e7)
```{r}
# above 2 per hour
mapview::mapview(
  frequencies_route_overline %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
st_write(frequencies_route_overline, "frequencies_route_overline.gpkg")
<<<<<<< Updated upstream
=======
```
</div>
</div>




<div style="display: flex; gap: 20px; overflow-x: auto;">
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e5)
```{r}
mapview::mapview(
  frequencies_route_overline_5 %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
```
</div>
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e4)
```{r}
# above 2 per hour
mapview::mapview(
  frequencies_route_overline_4 %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
>>>>>>> Stashed changes
```
</div>
</div>


<div style="display: flex; gap: 20px; overflow-x: auto;">
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e3)
```{r}
mapview::mapview(
  frequencies_route_overline_3 %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
```
</div>
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. 
```{r}

<<<<<<< Updated upstream

<div style="display: flex; gap: 20px; overflow-x: auto;">
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e5)
```{r}
mapview::mapview(
  frequencies_route_overline_5 %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
```
</div>
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e4)
```{r}
# above 2 per hour
mapview::mapview(
  frequencies_route_overline_4 %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
```
</div>
</div>


<div style="display: flex; gap: 20px; overflow-x: auto;">
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. (regionalise = 1e3)
```{r}
mapview::mapview(
  frequencies_route_overline_3 %>% filter(arrival_hour==8 & frequency > 2),
  zcol = "frequency",
  layer.name = "Frequency (hour)"
)
```
</div>
<div style="flex: 1 1 0; min-width: 288px; max-width: 100%;">
### Aggregated routes with overline for 8 a.m. 
```{r}

=======
>>>>>>> Stashed changes
```
</div>
</div>
