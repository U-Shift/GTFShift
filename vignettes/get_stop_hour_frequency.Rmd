---
title: "Get service frequency at stop per hour"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stop frequency analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(GTFShift)
```


# Introduction 

Analyzing public transit frequency is important to understand its territorial coverage and dynamics, both on its spatial and temporal dimensions. `GTFShift` provides a simple way to perform this analysis, through `GTFShift::get_stop_hour_frequency()` method, explored in this document.

# Download GTFS files 

## Data source

The gathering of the GTFS files can be simplified by using public archives like [transitfeeds.com](https://transitfeeds.com/) or [transit.land](https://www.transit.land/).

This library offers a small database with a compilation of GTFS files for Portuguese operators. It is a CSV file, available at `extdata/gtfs_sources_pt.csv`, and has the following attributes:

- `ID`, a string unique identifier of the region/city the GTFS file applies to;
- `LastUpdate`, the date at which this database entry was last updated;
- `ReferenceDate`, a representative Wednesday that falls within the GTFS calendar;
- `URL`, the URL at which the GTFS file is available;
- `GTFSDocs`, the URL to the page that documents the operator GTFS.


```{r message=TRUE, warning=FALSE}
data <- read.csv(system.file("extdata", "gtfs_sources_pt.csv", package = "GTFShift"))
summary(data)
data[1:4,]
```

## Download and validate integrity

`GTFShift` library offers a method to download and fix any integrity violations at GTFS files: `GTFShift::download()`. It fixes inconsistencies on the `stop_times.txt` and missing `shapes.txt` files.

```{r}
# DOWNLOAD GTFS and store it locally
gtfs_local <- GTFShift::download(data[4,]$URL, sprintf("database/transit/%s_gtfs.zip", data[4,]$ID))
```


# Analyse frequency

The frequency analysis is performed through `GTFShift::get_stop_hour_frequency()`, producing, for each stop, an aggregated counting of bus servicing it per hour.

```{r}
# Load GTFS
library(tidytransit)
gtfs <- tidytransit::read_gtfs(gtfs_local)

# Perform frequency analysis
frequencies <- GTFShift::get_stop_hour_frequency(gtfs)
```


It returns a data frame with the following columns:

- `stop_id`, the id of the stop, matching `stop_times.txt`;
- `hour`, the hour for which the aggregation applies;
- `frequency`, the number of bus services that serve that stop during that hour (60 minutes);
- `geometry`, the point coordinates of the stop.

```{r}
summary(frequencies)
```


# Distribute

IT can be displayed using `mapview`.

```{r}
library(mapview)
mapview::mapview(frequencies)
```


Or stored in GeoPackage format.

```{r}
library(sf)
st_write(frequencies, "database/transit/bus_stop_frequency.gpkg", append=FALSE)
```

