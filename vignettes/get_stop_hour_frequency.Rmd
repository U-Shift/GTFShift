---
title: "Get service frequency at stop per hour"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get service frequency at stop per hour}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(GTFShift)

library(tidytransit)
library(mapview)
```


# Introduction 

Analyzing public transit frequency is important to understand its territorial coverage and dynamics, both on its spatial and temporal dimensions. `GTFShift` provides a simple way to perform this analysis, through `GTFShift::get_stop_hour_frequency()` method, explored in this document.

> This article uses a GTFS feed from the library GTFS database for Portugal as an example. Refer to the \code{vignette("download")} for more details.

```{r}
# Get GTFS from library GTFS database for Portugal
data <- read.csv(system.file("extdata", "gtfs_sources_pt.csv", package = "GTFShift"))
gtfs_local <- GTFShift::download(data[4,]$URL, sprintf("database/transit/%s_gtfs.zip", data[4,]$ID))

# Load GTFS
gtfs <- tidytransit::read_gtfs(gtfs_local)
```


# Analyse frequency

The frequency analysis is performed through `GTFShift::get_stop_hour_frequency()`, producing, for each stop, an aggregated counting of bus servicing it per hour.

```{r}
# Perform frequency analysis
frequencies <- GTFShift::get_stop_hour_frequency(gtfs)
```


It returns a data frame with the following columns:

- `stop_id`, the id of the stop, matching `stop_times.txt`;
- `hour`, the hour for which the aggregation applies;
- `frequency`, the number of bus services that serve that stop during that hour (60 minutes);
- `geometry`, the point coordinates of the stop.

```{r}
summary(frequencies)
```

It can be displayed using mapview.

```{r}
mapview::mapview(frequencies)
```


Or stored in GeoPackage format.

```{r}
library(sf)
st_write(frequencies, "database/transit/bus_stop_frequency.gpkg", append=FALSE)
```

